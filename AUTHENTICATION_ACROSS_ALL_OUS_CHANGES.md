# การปรับแต่งการยืนยันตัวตนให้รองรับทุก Organizational Unit (OU)

## สรุปการเปลี่ยนแปลง

ระบบได้รับการปรับปรุงเพื่อให้ผู้ใช้สามารถเข้าสู่ระบบได้จากทุก Organizational Unit (OU) ใน Active Directory แทนที่จะจำกัดเฉพาะ OU ที่กำหนดไว้เท่านั้น

## ไฟล์ที่ได้รับการแก้ไข

### 1. `common/config/params.php`
- เพิ่มการตั้งค่า `search_all_ous => true` เพื่อเปิดใช้งานการค้นหาในทุก OU
- เพิ่มการตั้งค่า `allowed_ous => []` เพื่อกำหนด OU ที่อนุญาต (ว่างหมายถึงทุก OU)

### 2. `common/components/LdapHelper.php`
- ปรับปรุงฟังก์ชัน `authenticate()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `updateUser()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `getUser()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `getAllUsers()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `setAccountStatus()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `setPasswordExpiration()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `getUserByEmail()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `searchUsers()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `getUsersOutsideOUs()` เพื่อค้นหาผู้ใช้ในทุก OU
- ปรับปรุงฟังก์ชัน `getAllOUs()` เพื่อค้นหา OU ทั้งหมด
- เพิ่มฟังก์ชัน `testAuthenticationAcrossOUs()` เพื่อทดสอบการยืนยันตัวตน

### 3. `frontend/controllers/AdUserController.php`
- ปรับปรุงฟังก์ชัน `actionCheckUsername()` เพื่อค้นหาผู้ใช้ในทุก OU

## การตั้งค่าที่เปลี่ยนแปลง

### การตั้งค่าเดิม
```php
'ldap' => [
    'base_dn_user' => 'OU=rpp-user,DC=rpphosp,DC=local',
    'base_dn_reg' => 'OU=rpp-register,DC=rpphosp,DC=local',
    // ระบบค้นหาเฉพาะใน OU ที่กำหนด
]
```

### การตั้งค่าใหม่
```php
'ldap' => [
    'base_dn' => 'DC=rpphosp,DC=local',
    'base_dn_user' => 'OU=rpp-user,DC=rpphosp,DC=local',
    'base_dn_reg' => 'OU=rpp-register,DC=rpphosp,DC=local',
    'search_all_ous' => true,  // เปิดใช้งานการค้นหาในทุก OU
    'allowed_ous' => [],       // ว่างหมายถึงทุก OU
]
```

## ผลกระทบ

### ข้อดี
1. **ความยืดหยุ่น**: ผู้ใช้สามารถเข้าสู่ระบบได้จากทุก OU
2. **การจัดการที่ง่ายขึ้น**: ไม่ต้องจำกัดผู้ใช้ใน OU เฉพาะ
3. **รองรับการขยายตัว**: สามารถเพิ่ม OU ใหม่ได้โดยไม่ต้องแก้ไขโค้ด

### ข้อควรระวัง
1. **ความปลอดภัย**: ต้องตรวจสอบสิทธิ์การเข้าถึงในระดับ OU
2. **ประสิทธิภาพ**: การค้นหาในทุก OU อาจใช้เวลานานขึ้น
3. **การจัดการ**: ต้องมีการจัดการผู้ใช้ที่กระจายอยู่ในหลาย OU

## การทดสอบ

ใช้ไฟล์ `test_authentication_all_ous.php` เพื่อทดสอบการทำงาน:

```bash
php test_authentication_all_ous.php
```

## การใช้งาน

### สำหรับผู้ดูแลระบบ
1. ตรวจสอบการตั้งค่าใน `common/config/params.php`
2. ทดสอบการเชื่อมต่อ LDAP
3. ทดสอบการยืนยันตัวตนของผู้ใช้

### สำหรับผู้ใช้
- ผู้ใช้สามารถเข้าสู่ระบบได้จากทุก OU ใน Active Directory
- ไม่ต้องกังวลเรื่องตำแหน่ง OU ของบัญชีผู้ใช้

## การย้อนกลับ

หากต้องการย้อนกลับไปใช้การตั้งค่าเดิม:

1. ตั้งค่า `search_all_ous => false` ใน `params.php`
2. กำหนด `allowed_ous` เป็น OU ที่ต้องการ
3. หรือลบการตั้งค่า `search_all_ous` และ `allowed_ous` ออก

## หมายเหตุ

- การเปลี่ยนแปลงนี้ไม่กระทบต่อข้อมูลผู้ใช้ที่มีอยู่
- ระบบจะยังคงทำงานกับ OU เดิมได้ตามปกติ
- การค้นหาจะเริ่มจาก OU หลักก่อน แล้วจึงขยายไปยัง OU อื่นๆ
